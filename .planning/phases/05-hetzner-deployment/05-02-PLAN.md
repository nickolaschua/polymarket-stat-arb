---
phase: 05-hetzner-deployment
plan: 02
type: execute
---

<objective>
Provision a Hetzner CPX31 server in Frankfurt, deploy the collector daemon using the artifacts from Plan 05-01, and verify data is accumulating in TimescaleDB.

Purpose: Get the data collection pipeline running 24/7 on a non-geoblocked server so training data starts accumulating immediately. Every day without this = permanently lost minute-level market data.
Output: Live collector daemon on Hetzner, systemd-managed, with data flowing into TimescaleDB.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Deployment artifacts (created in 05-01):
@deploy/docker-compose.prod.yml
@deploy/deploy.sh
@deploy/polymarket-collector.service
@deploy/start-collector.sh
@deploy/encrypt-key.sh
@.env.production.example
@config.prod.yaml

# Infrastructure research:
@docs/AWS_INFRASTRUCTURE.md

**Constraining decisions:**
- Hetzner CPX31 Frankfurt ($14/mo, 4 vCPU, 8GB RAM, 160GB NVMe)
- German IP = not geoblocked by Polymarket
- age-encryption for wallet private key
- Docker for TimescaleDB, systemd for daemon
- Dedicated wallet for bot only — never access from US IP
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Provision Hetzner CPX31 Frankfurt and set up SSH access</action>
  <instructions>
  I've created all deployment artifacts in the `deploy/` directory. Now you need to provision the server.

  Steps:
  1. Go to https://console.hetzner.cloud/
  2. Create a new project (or use existing)
  3. Create a new server:
     - Location: **Frankfurt** (fsn1 or nbg1)
     - Image: **Ubuntu 24.04**
     - Type: **CPX31** (4 vCPU AMD, 8GB RAM, 160GB NVMe) — ~€13/mo
     - SSH Key: Add your public key (generate with `ssh-keygen -t ed25519` if needed)
     - Name: `polymarket-collector` (or your preference)
  4. Note the server's public IP address
  5. Test SSH access: `ssh root@<SERVER_IP>`
  6. Verify geoblocking: `ssh root@<SERVER_IP> "curl -s https://polymarket.com/api/geoblock"` — should return `{"blocked": false, ...}`
  </instructions>
  <verification>SSH access works and geoblock check returns blocked=false</verification>
  <resume-signal>Provide the server IP address when ready (e.g., "done, IP is 1.2.3.4")</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy collector daemon to the server</action>
  <instructions>
  Server is provisioned. Now deploy the application.

  **Step 1: Push latest code (including deploy/ artifacts) to your git remote:**
  ```bash
  git push origin main
  ```

  **Step 2: SSH into the server and run the bootstrap:**
  ```bash
  ssh root@<SERVER_IP>

  # Clone the repo (replace with your actual repo URL)
  git clone <YOUR_REPO_URL> /opt/polymarket-stat-arb
  cd /opt/polymarket-stat-arb

  # Create production environment file
  cp .env.production.example .env.production
  nano .env.production
  # Set POSTGRES_PASSWORD to a strong random value:
  #   openssl rand -base64 32
  # Leave POLY_PRIVATE_KEY empty (will use age encryption)

  # Run the bootstrap script
  chmod +x deploy/deploy.sh
  ./deploy/deploy.sh
  ```

  **Step 3: Set up age-encrypted private key:**
  ```bash
  # As the polymarket user
  sudo -u polymarket bash
  cd /opt/polymarket-stat-arb

  # Encrypt your private key (paste when prompted, Ctrl+D to end)
  chmod +x deploy/encrypt-key.sh
  echo "0xYOUR_PRIVATE_KEY_HERE" | ./deploy/encrypt-key.sh
  ```
  IMPORTANT: Never type the key directly into the terminal where it appears in shell history. Use `echo "..." |` piping or `read -s` approach.

  **Step 4: Start the collector daemon:**
  ```bash
  # Back as root
  exit
  systemctl start polymarket-collector
  systemctl status polymarket-collector
  ```

  The service should show "active (running)".
  </instructions>
  <verification>systemctl status polymarket-collector shows active (running)</verification>
  <resume-signal>Type "done" when the service is running, or describe any errors</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Collector daemon running as systemd service on Hetzner CPX31, with all 5 collectors (metadata, prices, orderbooks, trades, resolutions) writing to production TimescaleDB</what-built>
  <how-to-verify>
  SSH into the server and run these checks:

  1. **Service status:**
     ```bash
     systemctl status polymarket-collector
     ```
     Should show: active (running), no restart loops

  2. **Recent logs (health output):**
     ```bash
     journalctl -u polymarket-collector --since "5 minutes ago" --no-pager
     ```
     Should show: "=== Daemon Health ===" lines every 60s with items > 0

  3. **Database has data (wait 2-3 minutes after start):**
     ```bash
     docker compose -f /opt/polymarket-stat-arb/deploy/docker-compose.prod.yml exec timescaledb \
       psql -U polymarket -d polymarket -c "
         SELECT 'markets' AS tbl, count(*) FROM markets
         UNION ALL SELECT 'prices', count(*) FROM price_snapshots
         UNION ALL SELECT 'orderbooks', count(*) FROM orderbook_snapshots
         UNION ALL SELECT 'trades', count(*) FROM trades;
       "
     ```
     Should show: non-zero counts for at least markets and prices (orderbooks and trades may take a few minutes)

  4. **Docker container healthy:**
     ```bash
     docker ps --format "table {{.Names}}\t{{.Status}}"
     ```
     Should show: polymarket-timescaledb with status "Up ... (healthy)"

  5. **No crash-restart loops:**
     ```bash
     journalctl -u polymarket-collector | grep -c "Restarting"
     ```
     Should be 0 (or very low)

  6. **Geoblocking still clear:**
     ```bash
     curl -s https://polymarket.com/api/geoblock | python3 -m json.tool
     ```
     Should show: "blocked": false
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues to troubleshoot</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Hetzner server provisioned and accessible via SSH
- [ ] German IP confirmed not geoblocked
- [ ] Docker + TimescaleDB running on server
- [ ] Collector daemon running as systemd service
- [ ] Data accumulating in all tables (markets, prices, orderbooks, trades)
- [ ] Health logging shows all collectors active
- [ ] Service auto-restarts on failure (systemd Restart=always)
- [ ] Private key encrypted with age (not plaintext on disk)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Collector daemon running 24/7 on Hetzner CPX31 Frankfurt
- Data accumulating in TimescaleDB (verifiable via psql queries)
- systemd auto-restart configured for resilience
- Private key secured with age encryption
- Phase 5 complete — v0.1 Data Foundation milestone finished
</success_criteria>

<output>
After completion, create `.planning/phases/05-hetzner-deployment/05-02-SUMMARY.md`
</output>
